---
- name: Install munin packages
  package:
    name:
      - munin
      - munin-node
      - spawn-fcgi
    state: present
  tags:
    - role::munin

- name: Template munin configuration file
  template:
    src: munin.conf.j2
    dest: /etc/munin/munin.conf
    owner: root
    group: root
    mode: "0444"
  tags:
    - role::munin

- name: Template munin-node configuration file
  template:
    src: munin-node.conf.j2
    dest: /etc/munin/munin-node.conf
    owner: root
    group: root
    mode: "0444"
  tags:
    - role::munin
  notify:
    - Restart munin-node service

- name: Enable non-default munin plugins
  file:
    src: "/usr/share/munin/plugins/{{ item }}"
    dest: "/etc/munin/plugins/{{ item }}"
    state: link
  loop:
    - postfix_mailstats
    - spamstats
    - nginx_request
    - nginx_status
  tags:
    - role::munin
  notify:
    - Restart munin-node service

- name: Disable some unneeded plugins
  file:
    path: "/etc/munin/plugins/{{ item }}"
    state: absent
  loop:
    - squeezebox_albums
    - squeezebox_artists
    - squeezebox_genres
    - squeezebox_signalstrength
    - squeezebox_songs
    - squeezebox_volume
    - squeezebox_years
  tags:
    - role::munin
  notify:
    - Restart munin-node service
